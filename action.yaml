name: "davidkhala/build-dify-plugin"
description: 'GitHub Action to build Dify plugin package from pyproject.toml'

branding:
  icon: 'package' # find one in https://haya14busa.github.io/github-action-brandings/
  color: 'blue'
inputs:
  pyproject-directory:
    description: 'directory of pyproject.toml'
    required: true
runs:
  using: "composite"
  steps:
  - if: runner.os == 'Linux'
    run: |
      package=$(basename "${{ inputs.pyproject-directory }}")
      if [ "$package" = "." ] || [ -z "$package" ]; then
        package=$(basename "$GITHUB_WORKSPACE")
      fi
      echo "package=$package" >> $GITHUB_ENV
      LATEST_RELEASE=$(curl -s https://api.github.com/repos/langgenius/dify-plugin-daemon/releases/latest)
      DOWNLOAD_URL=$(echo $LATEST_RELEASE | jq -r '.assets[] | select(.name | contains("dify-plugin-linux-amd64")) | .browser_download_url' | head -1)
      curl -L -o $GITHUB_WORKSPACE/dify $DOWNLOAD_URL
      chmod +x $GITHUB_WORKSPACE/dify
      $GITHUB_WORKSPACE/dify version
    shell: bash
  - if: runner.os == 'macOS'
    run: |
      package=$(basename "${{ inputs.pyproject-directory }}")
      if [ "$package" = "." ] || [ -z "$package" ]; then
        package=$(basename "$GITHUB_WORKSPACE")
      fi
      echo "package=$package" >> $GITHUB_ENV
      LATEST_RELEASE=$(curl -s https://api.github.com/repos/langgenius/dify-plugin-daemon/releases/latest)
      DOWNLOAD_URL=$(echo $LATEST_RELEASE | jq -r '.assets[] | select(.name | contains("dify-plugin-darwin-arm64")) | .browser_download_url' | head -1)
      curl -L -o $GITHUB_WORKSPACE/dify $DOWNLOAD_URL
      chmod +x $GITHUB_WORKSPACE/dify
      $GITHUB_WORKSPACE/dify version
    shell: bash
  - if: runner.os == 'Windows'
    run: |
      $package = Split-Path "${{ inputs.pyproject-directory }}" -Leaf
      if ($package -eq '.' -or [string]::IsNullOrEmpty($package)) { $package = Split-Path $env:GITHUB_WORKSPACE -Leaf }
      "package=$package" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      $latest = Invoke-RestMethod https://api.github.com/repos/langgenius/dify-plugin-daemon/releases/latest
      $url = $latest.assets | Where-Object { $_.name -like "*dify-plugin-windows-amd64.exe*" } | Select-Object -First 1 | ForEach-Object { $_.browser_download_url }
      Invoke-WebRequest -Uri $url -OutFile "$env:GITHUB_WORKSPACE\dify.exe"
      & "$env:GITHUB_WORKSPACE\dify.exe" version
    shell: pwsh
  - if: runner.os == 'Linux'
    name: Build Dify plugin package
    run: $GITHUB_WORKSPACE/dify plugin package ${{ inputs.pyproject-directory }} --output_path "${GITHUB_WORKSPACE}/$package.difypkg"
    shell: bash