name: "davidkhala/build-dify-plugin"
description: ''

branding:
  icon: 'package' # find one in https://haya14busa.github.io/github-action-brandings/
  color: 'blue'
inputs:
  pyproject-directory:
    description: 'dir of pyproject.toml'
    required: true
runs:
  using: "composite"
  steps:
  - if: runner.os == 'Linux'
    run: |
      echo "repo=$(basename $GITHUB_WORKSPACE)" >> $GITHUB_ENV
      LATEST_RELEASE=$(curl -s https://api.github.com/repos/langgenius/dify-plugin-daemon/releases/latest)
      DOWNLOAD_URL=$(echo $LATEST_RELEASE | jq -r '.assets[] | select(.name | contains("dify-plugin-linux-amd64")) | .browser_download_url' | head -1)
      curl -L -o $GITHUB_WORKSPACE/dify $DOWNLOAD_URL
      chmod +x $GITHUB_WORKSPACE/dify
      $GITHUB_WORKSPACE/dify version
    shell: bash
  - if: runner.os == 'macOS'
    run: |
      echo "repo=$(basename $GITHUB_WORKSPACE)" >> $GITHUB_ENV
      LATEST_RELEASE=$(curl -s https://api.github.com/repos/langgenius/dify-plugin-daemon/releases/latest)
      DOWNLOAD_URL=$(echo $LATEST_RELEASE | jq -r '.assets[] | select(.name | contains("dify-plugin-darwin-arm64")) | .browser_download_url' | head -1)
      curl -L -o $GITHUB_WORKSPACE/dify $DOWNLOAD_URL
      chmod +x $GITHUB_WORKSPACE/dify
      $GITHUB_WORKSPACE/dify version
    shell: bash
  - if: runner.os == 'Windows'
    run: |
      $repo = Split-Path $env:GITHUB_WORKSPACE -Leaf
      "repo=$repo" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      $latest = Invoke-RestMethod https://api.github.com/repos/langgenius/dify-plugin-daemon/releases/latest
      $url = $latest.assets | Where-Object { $_.name -like "*dify-plugin-windows-amd64.exe*" } | Select-Object -First 1 | ForEach-Object { $_.browser_download_url }
      Invoke-WebRequest -Uri $url -OutFile "$env:GITHUB_WORKSPACE\dify.exe"
      & "$env:GITHUB_WORKSPACE\dify.exe" version
    shell: pwsh
  - if: runner.os == 'Linux'
    name: Build Dify plugin package
    working-directory: ${{ inputs.pyproject-directory }}
    run: |
      cd ../
      $GITHUB_WORKSPACE/dify plugin package $repo
      mv "$repo.difypkg" "${GITHUB_WORKSPACE}/$repo.difypkg"
    shell: bash